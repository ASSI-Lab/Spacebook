<!DOCTYPE html>
<html lang="it">
<head>

  	<title> Effettua prenotazioni - Spacebook </title>

</head>

<body>

	<% page_load_msg = '' %>

	<!-- L'utente deve selezionare un dipartimento -->
	<% if !local_assigns.has_key? :department %>
		<div class="row">
			<div class="col">
				<!-- Form per selezionare il dipartimento da prenotare -->
				<%= form_with url: set_department_path, local: true, method: :post do |form| %>
					<div class="row">
						<!-- Select dipartimento -->
						<div class="col-lg-9">
							<div class="form-floating mb-3">
								<%= form.select(:selected_dep_name, Department.order(:name).collect {|dep| [ dep.name ] }, {}, {class: "form-select", id: "depName"}) %>
								<label for="depName"> Seleziona il dipartimento </label>
							</div>
						</div>
						<!-- Bottone -->
						<div class="col-lg-3">
							<%= form.text_field :filter, value: "Dep", :style=>'display:none'%>
							<label class="mx-0 my-0 px-0 py-0" type="button" data-bs-toggle="modal" id="modalCaricamentoButton" data-bs-target="#modalCaricamento">
								<%= form.submit 'Filtra Dipartimento', class:"btn btn-outline-info my-2", style: "width: 100%; height: 40px" %>
							</label>
						</div>
					</div>
				<% end %>
			</div>
		</div>
	<!-- Solo se il dipartimento è stato selezionato, effettua il render dei successivi form, dei suoi dati e dele tabelle relative ai posti prenotabili -->
	<% else %><%
		# Inizializza il dipartimento selezionato
		selected_department = Department.where(name: department[:selected_dep_name]).first
		# Raccoglie gli orari del dipartimento dello spazio corrente
		selected_wd = WeekDay.where(department_id: selected_department.id)

		# Raccoglie gli id dei posti delle prenotazioni dell'utente corrente
		reserved_seats_ids = Reservation.where(user_id: current_user.id).collect {|res| [ res.seat_id ] }
		# Raccoglie l'eventuale prenotazione rapida dell'utente corrente
		current_qk_res = QuickReservation.all.where(user_id: current_user.id)

		# Array per l'inserimento dei giorni in italiano nella tabella
		it_days = ["Lunedì", "Martedì", "Mercoledì", "Giovedì", "Venerdì", "Sabato", "Domenica"]
		# La data di oggi
		today_date = (Date.today)

		# Dizionario per inizializzare i dati da inserire nelle righe della tabella
		days = {}
		it_days.each do |day_key|
			days["#{day_key}"] = ["Chiuso", 24, 0]
		end
		
		# Insericse i dati del dipartimento corrente in days e inizializza il minimo orario di apertura ed il massimo orario di chiusura della settimana
		selected_wd.where(state: "Aperto").each do |wd|
			days[wd.day] = [ wd.state, wd.apertura.hour, wd.chiusura.hour]
			@min = @min? ((@min > wd.apertura.hour)? wd.apertura.hour : @min) : wd.apertura.hour
			@max = @max? ((@max < wd.chiusura.hour)? wd.chiusura.hour : @max) : wd.chiusura.hour
		end

		selected_ty = (selected_spaces.collect {|ty| [ ty.typology ] }).uniq %>
		<!-- Mostra le componenti del form e inizializza le variabili a seconda dei filtri -->
		<%= form_with url: set_department_path, local: true, method: :post do |form| %>
			<div class="row">
				<!-- Mostra sempre il dipartimento selezionato nel form precedente -->
				<div class="col-lg-3">
					<div class="form-floating mb-3">
						<%= form.text_field :selected_dep_name, value: department[:selected_dep_name], style: "display:none" %>
						<div id="selDep" class="form-control"> <%= department[:selected_dep_name] %> </div>
						<label for="selDep"> Dipartimento </label>
					</div>
				</div>
				<!-- Select tipologia -->
				<div class="col-lg-3">
					<div class="form-floating mb-3">
						<!-- Se non è stata selezionata ne la tipologia ne lo spazio mostra il form per selezionarla -->
						<% if department[:filter] == "Dep" %>
							<% selected_spaces = Space.order(:typology).where(dep_name: params[:selected_dep_name]) %>
							<% department_ty = (selected_spaces.collect {|ty| [ ty.typology ] }).uniq %>
							<%= form.select(:selected_typology, department_ty, {}, {class: "form-select", id: "depTyp"}) %>
							<label for="depTyp"> Seleziona la tipologia </label>
						<!-- Altrimenti se è stata selezionata la tipologia ma non lo spazio, mostra la tipologia selezionata -->
						<% elsif department[:filter] == "Dep_Typ" or department[:filter] == "Dep_Typ_Sp" %>
							<% selected_spaces = Space.where(dep_name: params[:selected_dep_name], typology: params[:selected_typology]) %>
							<% selected_ty = [[department[:selected_typology]]] %>
							<%= form.text_field :selected_typology, value: department[:selected_typology], style: "display:none" %>
							<div id="selTyp" class="form-control"> <%= department[:selected_typology] %> </div>
							<label for="selTyp"> Tipologia </label>
						<% end %>
					</div>
				</div>
				<!-- Select spazio -->
				<div class="col-lg-3">
					<div class="form-floating mb-3">
						<!-- Se è stata selezionata la tipologia ma non è lo spazio inizializza gli spazi della tipologia selezionata e mostra il form per selezionare lo spazio -->
						<% if department[:filter] == "Dep_Typ" %>
							<% selected_spaces = Space.order(:name).where(dep_name: params[:selected_dep_name], typology: params[:selected_typology]) %>
							<%= form.select(:selected_space, (selected_spaces.collect {|sp| [ sp.name ] }), {}, {class: "form-select", id: "depTySp"}) %>
							<label for="depTySp"> Seleziona lo spazio </label>
						<!-- Altrimenti inizializza lo spazio selezionato e lo mostra -->
						<% elsif department[:filter] == "Dep_Typ_Sp" %>
							<% selected_spaces = Space.where(dep_name: params[:selected_dep_name], typology: params[:selected_typology], name: params[:selected_space]) %>
							<div id="depTySp" class="form-control"> <%= department[:selected_space] %> </div>
							<label for="depTySp"> Spazio </label>
						<% end %>
					</div>
				</div>
				<!-- Bottoni -->
				<div class="col-lg-3">
					<div class="row">
						<!-- Bottone per filtrare -->
						<% if department[:filter] != "Dep_Typ_Sp" %> 
							<div class="col-xl-6 py-2">
								<%= form.text_field :filter, value: (department[:filter] == "Dep")? "Dep_Typ" : "Dep_Typ_Sp", :style=>'display:none'%>
								<% if department[:filter] == "Dep_Typ" %> 
									<% page_load_msg = "Selezione dello spazio" %>
									<% btn_value = "Filtra spazio" %>
								<% else %>
									<% page_load_msg = "Selezione della tipologia" %>
									<% btn_value = "Filtra tipologia" %>
								<% end %>
								<label class="mx-0 my-0 px-0 py-0" data-bs-toggle="modal" id="modalCaricamentoButton" data-bs-target="#modalCaricamento" style="width:100%">
									<%= form.submit btn_value, class:"btn btn-outline-info", style: "width: 100%; height: 40px" %>
								</label>
							</div>
						<% end %>
						<!-- Bottone per elimina i filtri -->
						<div class="col-xl-6 py-2">
							<label class="mx-0 my-0 px-0 py-0" data-bs-toggle="modal" id="modalCaricamentoButton" data-bs-target="#modalCaricamento" style="width:100%">
								<%= link_to 'Rimuovi filtri', "/make_reservation", class:"btn btn-outline-info", style: "width: 100%; height: 40px" %>
							</label>
						</div>
					</div>
				</div>
			</div>
		<% end %>

		<!-- Mostra i vari dati e check per prenotare -->
		<div class="row">
			<div class="col">
				<div class="row">
					<div class="col-lg-12">
						<!-- Mostra tramite colapse il dipartimento in cui prenotare -->
						<div class="card">
							<div class="card-header">
								<label class="h3 mb-1"> <%= (selected_department).name %> </label> 
								<button class="btn btn-sm btn-outline-info bi bi-info-circle" data-bs-toggle="collapse" data-bs-target="#dep<%= selected_department.id %>InfoBodyCollapse" aria-expanded="false"></button>
							</div>
							<!-- Collapse del dipaartimento -->
							<div class="card-body collapse" id="dep<%= selected_department.id %>InfoBodyCollapse">
								<div class="row">
									<div class="col-lg-7">
										<!-- Descrizione -->
										<!-- Icona interattiva per visualizzare il collapse della descrizione -->
										<label class="label h5 py-1" data-bs-toggle="collapse" data-bs-target="#dep<%= selected_department.id %>DescCollapse" aria-expanded="false"> Descrizione <i class="bi bi-card-text"></i> </label> 
										<br>
										<%= selected_department.description %>
										<br>
											
										<!-- Dati -->
										<label class="label h5 py-1"> Posizione </label><br>
										<%= selected_department.via %>, <%= selected_department.civico %>, <%= selected_department.cap %>, <%= selected_department.citta %>, <%= selected_department.provincia %><br>

										<label class="label h5 py-1"> Numero piani </label><br>
										<%= selected_department.floors %><br>

										<label class="label h5 py-1"> Numero spazi </label><br>
										<%= selected_department.number_of_spaces %>
									</div>
									<!-- Carousel piante -->
									<div class="col-lg-5" style="vertical-align:middle">
										<div id="depFloorMapCarousel" class="carousel slide" data-bs-ride="carousel">
											<table width="100%">
												<tr>
													<td> <!-- Precedente -->
														<button class="btn btn-outline-info bi bi-caret-left-fill" data-bs-target="#depFloorMapCarousel" data-bs-slide="prev"></button>
													</td>
													<td width="100%"> <!-- Immagine del piano -->
														<div class="carousel-inner">
															<% [0,1,2].each do |num| %>
																<div class="carousel-item <%= (num == 0)? 'active' : '' %>">
																	<table width="100%">
																		<!-- Pianta del piano -->
																		<tr>
																			<td style="text-align:center">
																				<img class="card-img mt-2" id="depFloorMapCarouselImgTop" src="<%= (num == 1)? "https://i1.wp.com/fotografiaartistica.it/wp-content/uploads/2019/06/nasa-immagini-gratuite-dello-spazio.jpg?fit=1041%2C664&ssl=1" : (num == 2)? "https://cdna.artstation.com/p/assets/images/images/034/757/492/large/jorge-hardt-02112021-minimalist-japanese-mobile-hd.jpg?1613135473" : "https://st.depositphotos.com/2290789/3667/i/600/depositphotos_36675429-stock-photo-king-lion-aslan.jpg" %>" alt="..." />
																			</td>
																		</tr>
																		<!-- Piano -->
																		<tr>
																			<td>
																				<div class="label text-center h5">
																					<hr class="dropdown-divider mt-2"/>
																					<%= (num == 0)? "Piano terra" : "#{num}° Piano" %>
																				</div>
																			</td>
																		</tr>
																	</table>
																</div>
															<% end %>
														</div>
													</td>
													<td> <!-- Successiva -->
														<button class="btn btn-outline-info bi bi-caret-right-fill" data-bs-target="#depFloorMapCarousel" data-bs-slide="next"></button>
													</td>
												</tr>
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Mostra la pianta interattiva del dipartimento -->
				<% if selected_department.dep_map!=nil %>
				<div class="card shadow-lg border-0 rounded-lg mt-4">
					<div class="card-header text-center">
						<label class="font-weight-light h4 mt-4 mb-0"> Pianta del dipartimento </label>
						<div class="small text-muted"> Clicca sulla pianta per esplorare gli spazi del dipartimento selezionato. </div>
					</div>
					<div class="card-body">
						<ul class="list-group list-group-flush">
							<li class="list-group-item px-0">
								<div style="displa:flex">
									<!-- Spazio per inserire renderer Seatsio per visualizzazione pianta dipartimento -->
									<div id="chart"></div>
									<script src="https://cdn-eu.seatsio.net/chart.js"></script>

									<script>
										new seatsio.SeatingChart({
											divId: 'chart',
											workspaceKey: '<%= ENV['SEATS_IO_PUBLIC'] %>',
											event: '<%= selected_department.dep_event %>'
										}).render();
									</script>                                                        
								</div>
							</li>
						</ul>
					</div>
				</div>
				<% end %>
				
				<!-- Form per selezionare gli spazi e gli orari da prenotare -->
				<%= form_with url: make_res_path, local: true, method: :post do |form| %>
					<div class="row">
						<div class="col">
							<div class="card mt-4">
								<div class="card-header"> 
									<h3 class="mb-1"> Seleziona gli spazi che vuoi prenotare </h3>
									<p class="card-text text-muted pt-1"> Puoi visualizzare e prenotare più spazi contemporaneamente! </p>
								</div>
								<div class="card-body">
									<!-- Per ogni tipologia del dipartimento selezionato -->
									<% selected_ty.each do |current_ty| %>
										<div class="row">
											<div class="col">
												<div class="row">
													<div class="col-lg-2">
														<!-- Label interattiva per visualizzare il colapse con gli spazi della tipologia corrente -->
														<label class="dropdown-item h5" data-bs-toggle="collapse" data-bs-target="#spTypology<%= current_ty[0] %>ResTableCollapse" aria-expanded="false" aria-controls="collapseExample"> <%= current_ty[0] %> </label> 
													</div>
												</div>
												<div class="row">
													<!-- Collapse con gli spazi della tipologia corrente -->
													<div class="collapse" id="spTypology<%= current_ty[0] %>ResTableCollapse">
														<div class="col">

															<!-- Per ogni spazio del dipartimento corrente e della tipologia corrente -->
															<% selected_spaces.where(typology: current_ty).each do |current_sp| %>
																<!-- Raccoglie i posti dello spazio corrente -->
																<% @seats = Seat.where(space_id: current_sp.id).order(:position, :start_date) %>
																<!-- Raccoglie l'eventuale spazio preferito dell'utente corrente relativo allo spazio corrente -->
																<% current_fav_sp = FavouriteSpace.where(user_id: current_user.id, space_id: current_sp.id) %>

																<div class="row">
																	<div class="col-lg-2">
																		<!-- Label interattiva per visualizzare il colapse dello spazio corrente -->
																		<label class="dropdown-item h5 px-4" data-bs-toggle="collapse" data-bs-target="#spName<%= current_sp.id %>ResTableCollapse" aria-expanded="false" aria-controls="collapseExample">
																			<%= current_sp.name %>
																			<% if current_fav_sp.count == 1 %>
																				<i class="bi bi-bookmark-star"></i>
																			<% end %>
																		</label> 
																	</div>
																	<div class="col-lg-10">
																		<!-- Collapse dello spazio corrente -->
																		<div class="collapse" id="spName<%= current_sp.id %>ResTableCollapse">
																			<div class="row">
																				<!-- Tabella del colapse -->
																				<div class="col-lg-8">
																					<div class="card">
																						<div class="card-header text-left">
																							<p class="card-text text-muted pt-1"> Puoi prenotare più orari contemporaneamente! </p>
																						</div>
																						<div class="card-body pt-1">
																							<table id="orariMakeResTable" class="display table table-responsive table-hover" width="100%">
																								<tbody id="orariMakeResTableBody">
																									<!-- Prima riga che mostra il giorno della settimana e la data nel formato 'giorno-mese-anno' -->
																									<tr class="rigaHeaderOrariPrenotazione">
																										<td class="text-center" style="vertical-align:middle"> Orari </td>
																										<td class="text-center"><%= it_days[(today_date-1).wday] %><div class="dropdown-divider my-0"></div><%= (today_date+0).strftime("%d/%m/%Y") %></td>
																										<td class="text-center"><%= it_days[(today_date+0).wday] %><div class="dropdown-divider my-0"></div><%= (today_date+1).strftime("%d/%m/%Y") %></td>
																										<td class="text-center"><%= it_days[(today_date+1).wday] %><div class="dropdown-divider my-0"></div><%= (today_date+2).strftime("%d/%m/%Y") %></td>
																										<td class="text-center"><%= it_days[(today_date+2).wday] %><div class="dropdown-divider my-0"></div><%= (today_date+3).strftime("%d/%m/%Y") %></td>
																										<td class="text-center"><%= it_days[(today_date+3).wday] %><div class="dropdown-divider my-0"></div><%= (today_date+4).strftime("%d/%m/%Y") %></td>
																										<td class="text-center"><%= it_days[(today_date+4).wday] %><div class="dropdown-divider my-0"></div><%= (today_date+5).strftime("%d/%m/%Y") %></td>
																										<td class="text-center"><%= it_days[(today_date+5).wday] %><div class="dropdown-divider my-0"></div><%= (today_date+6).strftime("%d/%m/%Y") %></td>
																									</tr>
																									<!-- Corpo delle righe che mostra gli orari e le check per prenotare -->
																									<% (@max-@min).times do |h| %> <!-- Per ogni ora tra l'apertura minima e la chiusura massima -->
																										<tr><%
																											reserved_seats = [0, 0, 0, 0, 0, 0, 0]       # Array per tenere memoria se il posto è prenotato dall'utente corrente o meno
																											num_seats_per_day = [0, 0, 0, 0, 0, 0, 0]    # Array per tenere memoria del numero di posti liberi per ogni giorno
																											first_active_seat_id = [0, 0, 0, 0, 0, 0, 0] # Array per tenere memoria dell'id da prenotare nelle celle selezionate

																											# Inizializza le variabili sopra riportate per il completamento della tabella
																											@seats.each do |seat|
																												# Controlla se il posto ha un data e un tempo precedenti a quelli odierni
																												if ( seat.start_date.strftime("%Y%m%d%T") <= DateTime.now.strftime("%Y%m%d%T") )
																													# Se la data del posto è di oggi ma l'orario è passato basta mettere expired nello stato dello spazio
																													if ( seat.start_date.strftime("%Y%m%d") == DateTime.now.strftime("%Y%m%d") )
																														seat.update(state: "Expired")
																													# Se invece non è di oggi ma di un giorno precedente
																													else
																														# Aggiorna il nuovo posto con giorno corretto della settimana
																														seat.update(position: 1, start_date: seat.start_date+(604800), end_date: seat.end_date+(604800), state: "Active")

																														# Elimina le eventuali prenotazioni di quel posto
																														Reservation.where(seat_id: seat.id).each do |old_res|
																															old_res.destroy
																														end
																													end
																												end

																												if (seat.start_date.hour == @min+h) and (seat.start_date.strftime("%Y%m%d") == (today_date+0).strftime("%Y%m%d"))
																													if seat.state == "Expired" 
																														first_active_seat_id[0] = -1 
																													else
																														if seat.state == "Reserved" and (reserved_seats_ids.include? [seat.id])
																															reserved_seats[0] = 1
																														else
																															num_seats_per_day[0] = current_sp.number_of_seats - seat.position + 1
																															first_active_seat_id[0] = seat.id
																														end
																													end
																												elsif (seat.start_date.hour == @min+h) and (seat.start_date.strftime("%Y%m%d") == (today_date+1).strftime("%Y%m%d"))
																													if seat.state == "Reserved" and (reserved_seats_ids.include? [seat.id])
																														reserved_seats[1] = 1
																													else
																														num_seats_per_day[1] = current_sp.number_of_seats - seat.position + 1
																														first_active_seat_id[1] = seat.id
																													end
																												elsif (seat.start_date.hour == @min+h) and (seat.start_date.strftime("%Y%m%d") == (today_date+2).strftime("%Y%m%d"))
																													if seat.state == "Reserved" and (reserved_seats_ids.include? [seat.id])
																														reserved_seats[2] = 1
																													else
																														num_seats_per_day[2] = current_sp.number_of_seats - seat.position + 1
																														first_active_seat_id[2] = seat.id
																													end
																												elsif (seat.start_date.hour == @min+h) and (seat.start_date.strftime("%Y%m%d") == (today_date+3).strftime("%Y%m%d"))
																													if seat.state == "Reserved" and (reserved_seats_ids.include? [seat.id])
																														reserved_seats[3] = 1
																													else
																														num_seats_per_day[3] = current_sp.number_of_seats - seat.position + 1
																														first_active_seat_id[3] = seat.id
																													end
																												elsif (seat.start_date.hour == @min+h) and (seat.start_date.strftime("%Y%m%d") == (today_date+4).strftime("%Y%m%d"))
																													if seat.state == "Reserved" and (reserved_seats_ids.include? [seat.id])
																														reserved_seats[4] = 1
																													else
																														num_seats_per_day[4] = current_sp.number_of_seats - seat.position + 1
																														first_active_seat_id[4] = seat.id
																													end
																												elsif (seat.start_date.hour == @min+h) and (seat.start_date.strftime("%Y%m%d") == (today_date+5).strftime("%Y%m%d"))
																													if seat.state == "Reserved" and (reserved_seats_ids.include? [seat.id])
																														reserved_seats[5] = 1
																													else
																														num_seats_per_day[5] = current_sp.number_of_seats - seat.position + 1
																														first_active_seat_id[5] = seat.id
																													end
																												elsif (seat.start_date.hour == @min+h) and (seat.start_date.strftime("%Y%m%d") == (today_date+6).strftime("%Y%m%d"))
																													if seat.state == "Reserved" and (reserved_seats_ids.include? [seat.id])
																														reserved_seats[6] = 1
																													else
																														num_seats_per_day[6] = current_sp.number_of_seats - seat.position + 1
																														first_active_seat_id[6] = seat.id
																													end
																												end
																											end %>

																											<!-- Inserisce l'orario di riferimento della riga nel primo td -->
																											<td class="text-center"> <%= @min+h %>:00 - <%=@min+h+1%>:00 </td>
																											<!-- Inserisce i dati opportuni a seconda dei casi nei 7 td dei giorni della settimana -->
																											<% 7.times do |d_number| %>
																												<td class="text-center">
																													<!-- Controlla se è chiuso -->
																													<% current_wd_control = days[it_days[(today_date+d_number).wday-1]] %>
																													<% if current_wd_control[0] == "Chiuso" or (((@min+h) < current_wd_control[1]) or ((@min+h) >= current_wd_control[2])) %>
																														Chiuso
																													<!-- Controlla se ormai è un orario oltrepassato e quindi non più prenotabile -->
																													<% elsif first_active_seat_id[d_number] == -1 %>
																														<i class="bi bi-clock" style="color: grey"> Scaduto </i>
																													<!-- Controlla se l'utente corrente ha gia prenotato questo orario -->
																													<% elsif reserved_seats[d_number] == 1 %>
																														<i class="bi bi-check-circle" style="color: green"> Prenotato </i>
																													<!-- Controlla se i posti in quell'orario sono al completo -->
																													<% elsif num_seats_per_day[d_number] == 0 %>
																														<i class="bi bi-x-circle" style="color: red"> Completo </i>
																													<!-- Se non ci troviamo in nessuno dei casi precedenti scrive il numero di posti disponibili e Mostra lo switch per prenotare -->
																													<% else %>
																														<div class="form-check form-switch ms-auto me-auto mx-1 my-1 px-0" style="width:fit-content">
																															<%= form.check_box((first_active_seat_id[d_number].to_s), { class: "form-check-input mx-0 px-0", type: "checkbox"}, checked_value = "MakeRes", unchecked_value = "0") %>
																															<label class="h6 my-0 mx-1" for="<%= first_active_seat_id[d_number] %>"> <%= num_seats_per_day[d_number] %> </label>
																														</div>
																													<% end %>
																												</td>
																											<% end %>
																										</tr>
																									<% end %>
																								</tbody>
																							</table>
																						</div>
																					</div>
																				</div>
																				<!-- Informazioni e azioni del colapse -->
																				<div class="col-lg-4">
																					<div class="card">
																						<div class="card-header text-left">
																							<p class="card-text text-muted h5 pt-1"> Pianta </p>
																						</div>
																						<!-- Pianta dello spazio + descrizione -->
																						<div class="card-body">
																							<img class="card-img" id="depFloorMapImg" src="https://i1.wp.com/fotogafiaartistica.it/wp-content/uploads/2019/06/nasa-immagini-gratuite-dello-spazio.jpg?fit=1041%2C664&ssl=1" alt="..." />

																							<div class="dropdown-divider my-3"></div>

																							<label class="h5"> Descrizione </label><br>
																							<%= current_sp.description %>
																						</div>
																						<!-- Azioni per lo spazio corrente -->
																						<div class="card-footer">
																							<!-- Spazio preferito -->
																							<div class="form-check form-switch ms-auto me-auto mx-1 my-1 px-0">
																								<table width="100%">
																									<tr>
																										<!-- Se l'utente ha aggiunto lo spazio corrente tra i preferiti, propone la rimozione -->
																										<% if current_fav_sp.count == 1 %>
																											<td><label class="h5"> Rimuovi spazio dalla lista preferiti </label></td>
																											<td><%= form.check_box((current_fav_sp.first.id.to_s), { class: "form-check-input mx-3 px-0", type: "checkbox", style: "float: right !important" }, checked_value = "RmFavSp", unchecked_value = "0") %></td>
																										<!-- Se l'utente ha aggiunto lo spazio corrente tra i preferiti, propone l'aggiunta -->
																										<% else %>
																											<td><label class="h5"> Aggiungi spazio ai preferiti </label></td>
																											<td><%= form.check_box((((current_sp.id)*(-1)).to_s), { class: "form-check-input mx-3 px-0", type: "checkbox", style: "float: right !important" }, checked_value = "AddFavSp", unchecked_value = "0") %></td>
																										<% end %>
																									</tr>
																								</table>
																							</div>
																							<div class="dropdown-divider"></div>
																							<!-- Prenotazione rapida -->
																							<div class="form-check form-switch ms-auto me-auto mx-1 my-1 px-0">
																								<table width="100%">
																									<tr>
																										<!-- Se l'utente ha gia impostato una prenotazione rapida -->
																										<% if current_qk_res.count == 1 %>
																											<!-- Se non è relativa allo spazio corrente propone lo scambio -->
																											<% if current_qk_res.first.space_id != current_sp.id %>
																												<td>
																													<label class="h5 mb-1"> Prenotazione rapida attuale: </label><br>
																													<%= current_qk_res.first.dep_name %>: <%= current_qk_res.first.typology %> - <%= current_qk_res.first.space_name %><br>
																													<label class="h5 mb-1"> Sostituisci con: </label><br>
																													<%= current_sp.dep_name %>: <%= current_sp.typology %> - <%= current_sp.name %>
																												</td>
																												<td><%= form.check_box(("QR").concat((current_sp.id).to_s), { class: "form-check-input mx-3 px-0", type: "checkbox", style: "float: right !important" }, checked_value = "UpdateQkRes", unchecked_value = "0") %></td>
																											<!-- Se invece lo spazio coente è lo stesso della prenotazione rapida, propone la rimozione -->
																											<% else %>
																												<td><label class="h5"> Rimuovi prenotazione rapida </label></td>
																												<td><%= form.check_box(("QR").concat((current_sp.id).to_s), { class: "form-check-input mx-3 px-0", type: "checkbox", style: "float: right !important" }, checked_value = "RmQkRes", unchecked_value = "0") %></td>
																											<% end %>
																										<!-- Se invece l'utente non ha impostato una prenotazione rapida, propone di impostarla -->
																										<% else %>
																											<td>
																												<label class="h5"> Imposta come prenotazione rapida </label><br>
																												Solo uno spazio può essere impostato come P.R. se ne selezioni più di uno ne verrà impostato uno solo tra quelli.
																											</td>
																											<td><%= form.check_box(("QR").concat((current_sp.id).to_s), { class: "form-check-input mx-3 px-0", type: "checkbox", style: "float: right !important" }, checked_value = "SetQkRes", unchecked_value = "0") %></td>
																										<% end %>
																									</tr>
																								</table>
																							</div>
																						</div>
																					</div>
																				</div>
																			</div>
																		</div>
																	</div>
																</div>
															<% end %>
														</div>
													</div>
												</div>
											</div>
										</div>
									<% end %>
								</div>
							</div>
						</div>
					</div>
					<div class="mt-4" style="text-align: right">
						<!-- Se l'utente ha effettuato l'accesso con google, potrà sincronizzare le prenotazioni su calendar -->
						<% if current_user.access_token!=nil %>
							<div class="form-check form-switch ms-auto me-auto mx-1 my-1 px-0">
								<%= form.check_box(("calendar_check"), { class: "form-check-input mx-1 px-0", type: "checkbox" }) %>
								<label class="h6 my-0 mx-1" for="calendar_check"> Sincronizza prenotazioni su Calendar </label>
							</div>
						<% end %>
						<!-- Invia i dati per gli orari selezionati alla funzione per la creazione -->
						<%= form.submit "Conferma", data: { confirm: "Prenotare gli orari selezionati e procedere con le azioni selezionate per gli spazi?" }, class: "btn btn-outline-info mt-2" %>
					</div>
				<% end %>
			</div>
		</div>
	<% end %>

	<!-- Modal che si sovrappone al sito durante i caricamenti -->
	<%= render 'layouts/modal_loading', msg: page_load_msg %>

</body>
</html>