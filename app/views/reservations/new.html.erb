<!DOCTYPE html>
<html lang="it">
<head>

  	<title> Effettua prenotazioni - Spacebook </title>

	<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
	<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap.min.js"></script>
	<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
	<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap.min.css">

	<script>
        $(document).ready(function () {
            $('#datatableOrari').DataTable({
                dom: '<"row"<"col"t>><"row mt-0">',
                scrollX: true,
                filter: 'false',
                pageLength: 24,
				ordering: false
            })
        });
    </script>

</head>

<body>
	<div class="row">
		<div class="col-lg-12">
			<div class="form-floating mb-3">
				<!-- Form per selezionare il dipartimento da prenotare -->
				<%= form_with url: set_department_path, local: true, method: :post do |form| %>
					<div class="row">
						<div class="col-lg-6">
							<div class="form-floating mb-3">
								<%= form.select(:name, Department.all.collect {|dep| [ dep.name ] }, {}, {class: "form-select", id: "depName"}) %>
								<label for="depName"> Seleziona il dipartimento </label>
							</div>
						</div>
						<div class="col-lg-6">
							<div class="action">
								<%= form.submit class:"btn btn-lg btn-outline-info", value: 'Continua'%>
							</div>
						</div>
					</div>
				<% end %>
			</div>
		</div>

		<!-- Solo se il dipartimento è stato selezionato, effettua il render dei suoi dati e dele tabelle relative ai posti prenotabili -->
		<% if local_assigns.has_key? :department %>
			<div class="col-lg-12">
				<div class="row">
					<div class="col-lg-6">
						<div class="card shadow-lg border-0 rounded-lg">
							<div class="card-header text-left">
								<h3 class="font-weight-light mb-1"> Ricerca con filtri </h3>
								<p class="card-text text-muted pt-1"> Visualizza solo la tipologia o lo spazio che ti interessa! </p>
							</div>
							<div class="card-body">
								<label for="depName"> Seleziona la tipologia </label>
								<br>
								<label for="depName"> Seleziona lo spazio </label>
							</div>
						</div>
					</div>
					<div class="col-lg-6">
						<% @department = Department.where(name: department[:name]).first %>
						<!-- Mostra il dipartimento in cui prenotare -->
						<div class="card shadow-lg border-0 rounded-lg">
							<div class="card-header"> 
								<h3 class="font-weight-light mb-1"> <%= (@department).name %> </h3>
								<p class="card-text text-muted pt-1"> 
									<%= (@department).via %>, <%= (@department).civico %>, <%= (@department).cap %>, <%= (@department).citta %>, <%= (@department).provincia %>
								</p>
							</div>
							<div class="card-body">
								<ul class="list-group list-group-flush">
									<!-- Descrizione -->
									<li class="list-group-item pt-0">
										<!-- Icona interattiva per visualizzare il collapse della descrizione -->
										<label class="label h5" data-bs-toggle="collapse" data-bs-target="#dep<%= (@department).id %>DescCollapse" aria-expanded="false" aria-controls="collapseExample"> Descrizione <i class="bi bi-card-text"></i> </label> 
										<!-- Collapse della descrizione -->
										<div class="collapse" id="dep<%= (@department).id %>DescCollapse">
											<%= (@department).description %>
										</div>
									</li>
									<!-- Carousel piante -->
									<li class="list-group-item pt-0">
										<div id="depFloorMapCarousel" class="carousel slide" data-bs-ride="carousel">
											<table width="100%">
												<tr>
													<td> <!-- Precedente -->
														<button class="btn btn-outline-info bi bi-caret-left-fill" data-bs-target="#depFloorMapCarousel" data-bs-slide="prev"></button>
													</td>
													<td> <!-- Immagine del piano -->
														<div class="carousel-inner">
															<% [0,1,2].each do |num| %>
																<div class="carousel-item <%= (num == 0)? 'active' : '' %>">
																	<table width="100%">
																		<!-- Pianta del piano -->
																		<tr>
																			<td style="text-align:center">
																				<img class="card-img mt-2" id="depFloorMapCarouselImgTop" src="<%= (num == 1)? "https://i1.wp.com/fotografiaartistica.it/wp-content/uploads/2019/06/nasa-immagini-gratuite-dello-spazio.jpg?fit=1041%2C664&ssl=1" : (num == 2)? "https://cdna.artstation.com/p/assets/images/images/034/757/492/large/jorge-hardt-02112021-minimalist-japanese-mobile-hd.jpg?1613135473" : "https://st.depositphotos.com/2290789/3667/i/600/depositphotos_36675429-stock-photo-king-lion-aslan.jpg" %>" alt="..." />
																			</td>
																		</tr>
																		<!-- Piano -->
																		<tr>
																			<td>
																				<div class="label text-center h5">
																					<hr class="dropdown-divider mt-2"/>
																					<%= (num == 0)? "Piano terra" : "#{num}° Piano" %>
																				</div>
																			</td>
																		</tr>
																	</table>
																</div>
															<% end %>
														</div>
													</td>
													<td> <!-- Successiva -->
														<button class="btn btn-outline-info bi bi-caret-right-fill" data-bs-target="#depFloorMapCarousel" data-bs-slide="next"></button>
													</td>
												</tr>
											</table>
										</div>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
				<!-- Form per selezionare gli spazi e gli orari da prenotare -->
				<%= form_with url: make_res_path, local: true, method: :post do |form| %>
					<div class="row">
						<div class="col">
							<div class="card shadow-lg border-0 rounded-lg mt-4">
								<div class="card-header"> 
									<h3 class="font-weight-light mb-1"> Seleziona gli spazi che vuoi prenotare </h3>
									<p class="card-text text-muted pt-1"> Puoi prenotare più spazi e più giorni contemporaneamente! </p>
								</div>
								<div class="card-body">
									<% (Space.where(department_id: @department.id).collect {|ty| [ ty.typology ] }).uniq.each do |sps_typ| %>
										<div class="row">
											<div class="col">
												<div class="row">
													<div class="col-lg-2">
														<!-- Label interattiva per visualizzare gli spazi della tipologia corrente -->
														<label class="dropdown-item h5" data-bs-toggle="collapse" data-bs-target="#spTypology<%= sps_typ[0] %>ResTableCollapse" aria-expanded="false" aria-controls="collapseExample"> <%= sps_typ[0] %> </label> 
													</div>
												</div>
												<div class="row">
													<!-- Collapse con gli spazi della tipologia corrente -->
													<div class="collapse" id="spTypology<%= sps_typ[0] %>ResTableCollapse">
														<div class="col">
															<% (Space.where(department_id: @department.id, typology: sps_typ[0])).each do |sp| %>
																<div class="row">
																	<div class="col-lg-2">
																		<!-- Label interattiva per visualizzare la tabella dello spazio -->
																		<label class="dropdown-item h5 px-4" data-bs-toggle="collapse" data-bs-target="#spName<%= (sp).id %>ResTableCollapse" aria-expanded="false" aria-controls="collapseExample"> <%= sp.name %> </label> 
																	</div>
																	<div class="col-lg-10"> <%
																		# Raccoglie gli orari del dipartimento dello spazio corrente
																		@week_days = WeekDay.where(department_id: @department.id)
																		# Inizializza il minimo orario di apertura ed il massimo orario di chiusura della settimana
																		@week_days.where(state: "Aperto").each do |wd|
																			@min = @min? ((@min > wd.apertura.hour)? wd.apertura.hour : @min) : wd.apertura.hour
																			@max = @max? ((@max < wd.chiusura.hour)? wd.chiusura.hour : @max) : wd.chiusura.hour
																		end
																		# Raccoglie i posti dello spazio corrente
																		@seats = Seat.where(space_id: sp.id)
																		# La data di oggi
																		@today = (Date.today)
																		# Array per l'inserimento dei giorni in italiano nella tabella
																		@days = ["Lunedì", "Martedì", "Mercoledì", "Giovedì", "Venerdì", "Sabato", "Domenica"] %>
																		
																		<!-- Collapse della tabella -->
																		<div class="collapse" id="spName<%= (sp).id %>ResTableCollapse">
																			<div class="row">
																				<div class="col-lg-9">
																					<div class="card shadow-lg border-0 rounded-lg">
																						<div class="card-header text-left">
																							<p class="card-text text-muted pt-3"> <%= sp.description %> </p>
																						</div>
																						<div class="card-body pt-1">
																							<table id="datatableOrari" class="display table-responsive table-striped table-hover" width="100%">
																								<thead> <!-- Header che mostra il giorno della settimana e la data nel formato 'giorno-mese-anno' -->
																									<tr>
																										<td class="text-center"> Orari </td>
																										<td class="text-center"><%= @days[(@today+0).wday - 1] %><div class="dropdown-divider my-0"></div><%= (@today+0).mday %> / <%= (@today+0).mon %> / <%= (@today+0).year %></td>
																										<td class="text-center"><%= @days[(@today+1).wday - 1] %><div class="dropdown-divider my-0"></div><%= (@today+1).mday %> / <%= (@today+1).mon %> / <%= (@today+1).year %></td>
																										<td class="text-center"><%= @days[(@today+2).wday - 1] %><div class="dropdown-divider my-0"></div><%= (@today+2).mday %> / <%= (@today+2).mon %> / <%= (@today+2).year %></td>
																										<td class="text-center"><%= @days[(@today+3).wday - 1] %><div class="dropdown-divider my-0"></div><%= (@today+3).mday %> / <%= (@today+3).mon %> / <%= (@today+3).year %></td>
																										<td class="text-center"><%= @days[(@today+4).wday - 1] %><div class="dropdown-divider my-0"></div><%= (@today+4).mday %> / <%= (@today+4).mon %> / <%= (@today+4).year %></td>
																										<td class="text-center"><%= @days[(@today+5).wday - 1] %><div class="dropdown-divider my-0"></div><%= (@today+5).mday %> / <%= (@today+5).mon %> / <%= (@today+5).year %></td>
																										<td class="text-center"><%= @days[(@today+6).wday - 1] %><div class="dropdown-divider my-0"></div><%= (@today+6).mday %> / <%= (@today+6).mon %> / <%= (@today+6).year %></td>
																									</tr>
																								</thead>
																								<tbody> <!-- Body che mostra gli orari e le check per prenotare -->
																									<!-- Per ogni ora tra l'apertura e la chiusura -->
																									<% (@max-@min).times do |h| %>
																										<tr><%
																											reserved_seats_ids = Reservation.where(user_id: current_user.id).collect {|res| [ res.seat_id ] } # id dei posti delle prenotazioni dell'utente corrente
																											reserved_seats = [0, 0, 0, 0, 0, 0, 0]                                                            # Array per tenere memoria se il posto è prenotato dall'utente corrente o meno
																											num_seats_per_day = [0, 0, 0, 0, 0, 0, 0]                                                         # Array per tenere memoria del numero di posti liberi per ogni giorno
																											first_active_seat_id = [0, 0, 0, 0, 0, 0, 0]                                                      # Array per tenere memoria dell'id da prenotare nelle celle selezionate

																											# Inizializza le variabili sopra riportate per il completamento della tabella
																											(@seats.order(:position, :start_date)).each do |seat|
																												seat_s_d = seat.start_date
																												if (seat_s_d.hour == @min+h) and (seat_s_d.strftime("%Y%m%d") == (@today+0).strftime("%Y%m%d"))
																													if seat.state == "Expired" 
																														first_active_seat_id[0] = -1 
																													else
																														if seat.state == "Reserved"
																															reserved_seats[0] = (reserved_seats_ids.include? [seat.id])? 1 : reserved_seats[0];
																														else
																															num_seats_per_day[0] += 1
																															first_active_seat_id[0] = (first_active_seat_id[0] == 0)? seat.id : first_active_seat_id[0]
																														end
																													end
																												elsif (seat_s_d.hour == @min+h) and (seat_s_d.strftime("%Y%m%d") == (@today+1).strftime("%Y%m%d"))
																													if seat.state == "Reserved"
																														reserved_seats[1] = (reserved_seats_ids.include? [seat.id])? 1 : reserved_seats[1];
																													else
																														num_seats_per_day[1] += 1
																														first_active_seat_id[1] = (first_active_seat_id[1] == 0)? seat.id : first_active_seat_id[1]
																													end
																												elsif (seat_s_d.hour == @min+h) and (seat_s_d.strftime("%Y%m%d") == (@today+2).strftime("%Y%m%d"))
																													if seat.state == "Reserved"
																														reserved_seats[2] = (reserved_seats_ids.include? [seat.id])? 1 : reserved_seats[2];
																													else
																														num_seats_per_day[2] += 1
																														first_active_seat_id[2] = (first_active_seat_id[2] == 0)? seat.id : first_active_seat_id[2]
																													end
																												elsif (seat_s_d.hour == @min+h) and (seat_s_d.strftime("%Y%m%d") == (@today+3).strftime("%Y%m%d"))
																													if seat.state == "Reserved"
																														reserved_seats[3] = (reserved_seats_ids.include? [seat.id])? 1 : reserved_seats[3];
																													else
																														num_seats_per_day[3] += 1
																														first_active_seat_id[3] = (first_active_seat_id[3] == 0)? seat.id : first_active_seat_id[3]
																													end
																												elsif (seat_s_d.hour == @min+h) and (seat_s_d.strftime("%Y%m%d") == (@today+4).strftime("%Y%m%d"))
																													if seat.state == "Reserved"
																														reserved_seats[4] = (reserved_seats_ids.include? [seat.id])? 1 : reserved_seats[4];
																													else
																														num_seats_per_day[4] += 1
																														first_active_seat_id[4] = (first_active_seat_id[4] == 0)? seat.id : first_active_seat_id[4]
																													end
																												elsif (seat_s_d.hour == @min+h) and (seat_s_d.strftime("%Y%m%d") == (@today+5).strftime("%Y%m%d"))
																													if seat.state == "Reserved"
																														reserved_seats[5] = (reserved_seats_ids.include? [seat.id])? 1 : reserved_seats[5];
																													else
																														num_seats_per_day[5] += 1
																														first_active_seat_id[5] = (first_active_seat_id[5] == 0)? seat.id : first_active_seat_id[5]
																													end
																												elsif (seat_s_d.hour == @min+h) and (seat_s_d.strftime("%Y%m%d") == (@today+6).strftime("%Y%m%d"))
																													if seat.state == "Reserved"
																														reserved_seats[6] = (reserved_seats_ids.include? [seat.id])? 1 : reserved_seats[6];
																													else
																														num_seats_per_day[6] += 1
																														first_active_seat_id[6] = (first_active_seat_id[6] == 0)? seat.id : first_active_seat_id[6]
																													end
																												end
																											end %>

																											<!-- Inserisce l'orario di riferimento della riga nel primo td -->
																											<td class="text-center"> <%= @min+h %>:00 - <%=@min+h+1%>:00 </td>
																											<!-- Inserisce i dati opportuni a seconda dei casi nei 7 td dei giorni della settimana -->
																											<% 7.times do |d_number| %>
																												<td class="text-center">
																													<!-- Controlla se è chiuso -->
																													<% if @week_days.where(day: @days[(@today+d_number).wday-1]).first.state == "Chiuso" or ((@min+h < @week_days.where(day: @days[(@today+d_number).wday-1]).first.apertura.hour) or (@min+h >= @week_days.where(day: @days[(@today+d_number).wday-1]).first.chiusura.hour)) %>
																														Chiuso
																													<% else %>
																														<!-- Controlla se ormai è un orario oltrepassato e quindi non più prenotabile -->
																														<% if first_active_seat_id[d_number] == -1 %>
																															<i class="bi bi-clock" style="color: grey"> Scaduto </i>
																														<% else %>
																															<!-- Controlla se l'utente corrente ha gia prenotato questo orario -->
																															<% if reserved_seats[d_number] == 1 %>
																																<i class="bi bi-check-circle" style="color: green"> Prenotato </i>
																															<!-- Controlla se i posti in quell'orario sono al completo -->
																															<% elsif num_seats_per_day[d_number] == 0 %>
																																<i class="bi bi-x-circle" style="color: red"> Completo </i>
																															<!-- Se non ci troviamo in nessuno dei casi precedenti scrive il numero di posti disponibili e Mostra lo switch per prenotare -->
																															<% else %>
																																<div class="form-check form-switch ms-auto me-auto mx-1 my-1 px-0" style="width:fit-content">
																																	<%= form.check_box((first_active_seat_id[d_number].to_s), { class: "form-check-input mx-0 px-0", type: "checkbox"}) %>
																																	<label class="h6 my-0 mx-1" for="<%= first_active_seat_id[d_number] %>"> <%= num_seats_per_day[d_number] %> </label>
																																</div>
																															<% end %>
																														<% end %>
																													<% end %>
																												</td>
																											<% end %>
																										</tr>
																									<% end %>
																								</tbody>
																							</table>
																						</div>
																					</div>
																				</div>
																				<div class="col-lg-3">
																					<div class="card shadow-lg border-0 rounded-lg">
																						<div class="card-header text-left">
																							<p class="card-text text-muted pt-3"> Pianta </p>
																						</div>
																						<div class="card-body">
																							<img class="card-img mt-2" id="depFloorMapImg" src="https://i1.wp.com/fotografiaartistica.it/wp-content/uploads/2019/06/nasa-immagini-gratuite-dello-spazio.jpg?fit=1041%2C664&ssl=1" alt="..." />
																						</div>
																						<div class="card-footer">
																							<button class="btn btn-outline-info" style="width: 100%"> Imposta spazio per la prenotazione rapida </button>
																							<button class="btn btn-outline-info mt-1" style="width: 100%"> Aggiungi spazio ai preferiti </button>
																						</div>
																					</div>
																				</div>
																			</div>
																		</div>
																	</div>
																</div>
															<% end %>
														</div>
													</div>
												</div>
											</div>
										</div>
									<% end %>
								</div>
							</div>
						</div>
					</div>
					<div class="row mt-4" style="text-align: right">
						<% if current_user.access_token!=nil %>
							<div class="form-check form-switch ms-auto me-auto mx-1 my-1 px-0">
								<%= form.check_box(("calendar_check"), { class: "form-check-input mx-3 px-0", type: "checkbox" }) %>
								<label class="h6 my-0 mx-1" for="calendar_check"> Sincronizza prenotazione su Calendar </label>
							</div>
						<% end %>
						<div class="action">
							<!-- Invia i dati per gli orari selezionati alla funzione per la creazione -->
							<%= form.submit class: "btn btn-outline-info", value: "Prenota gli orari selezionati" %>
						</div>
					</div>
				<% end %>
			</div>
		<% end %>
	</div>
</body>
</html>