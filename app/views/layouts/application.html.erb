<!DOCTYPE html>
<html lang="it">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

</head>

<body class="sb-nav-fixed">

    <!-- Controlla se l'utente ha effettuato l'accesso, se è manager e se non ha ancora un dipartimento creato -->
    <% if user_signed_in? and current_user.is_manager? and !current_page?('/make_department') and (Department.where(manager: current_user.email).count == 0) %> 
        <% require_department %> <!-- In caso positivo viene reindirizzato di forza alla pagina '/make_department' tramite la funzione sotto riportata (Si veda 'application_controller.rb' per il corpo della funzione) -->
    <% end %>

    <!-- Cattura i messaggi di notifica e li mostra nel modal delle notifiche flash -->
    <% @flash_messages = [] %>
    <% flash.each do |type, msg| %>
        <% @flash_messages.concat([msg]) %>
    <% end %>

    <!-- Header del sito -->
    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark ">
        <table width="100%">
            <tr>
                <!-- Icone alternate per sidenav e home -->
                <td width="6%" style="text-align:left">
                    <% if !current_page?("/users/sign_up") and !current_page?("/users/sign_in") and !current_page?("/make_department")%>
                        <!-- Icona per il toggle della sidenav -->
                        <div class="btn btn-outline-info bi bi-arrow-left-right ms-3" id="sidebarToggle"></div>
                    <% else %>
                        <!-- Icona per il reindirizzamento alla home in assenza della sidenav -->
                        <div class="btn btn-outline-info bi bi-house-fill ms-3" id="homeBtnWhenNoSidenav" onclick="window.location.href='/home'"></div>
                    <% end %>
                </td>
                <!-- Brand -->
                <td width="88%">
                    <a class="navbar-brand text-center"><h1> S P A C E B O O K </h1></a>
                </td>
                <!-- Icona interattiva per visualizzare le notifiche flash da spacebook -->
                <td width="3%" style="text-align:right">
                    <% if @flash_messages.size != 0%>
                        <div class="btn btn-outline-info bi bi-chat-text-fill me-3" type="button" data-bs-toggle="modal" id="flashNavModalButton" data-bs-target="#flashNavModal">
                            <!-- Badge con il numero di messaggi -->
                            <span class="position-absolute badge rounded-pill bg-danger mt-1"><%= @flash_messages.size %></span>
                        </div>
                    <% else %>
                        <div class="btn btn-outline-info bi bi-chat me-3" type="button" data-bs-toggle="modal" id="flashNavModalButton" data-bs-target="#flashNavModal"></div>
                    <% end %>
                </td>
                <!-- Icona interattiva per visualizzare il modal dell'utente -->
                <td width="3%" style="text-align:right">
                    <% if user_signed_in?%>
                        <div class="btn btn-outline-info bi bi-person-fill me-3" type="button" data-bs-toggle="modal" id="userNavModalButton" data-bs-target="#userNavModal"></div>
                    <% else %>
                        <div class="btn btn-outline-info bi bi-person me-3" type="button" data-bs-toggle="modal" id="userNavModalButton" data-bs-target="#userNavModal"></div>
                    <% end %>
                </td>
            </tr>
        </table>
    </nav>

    <!-- Modal dell'utente -->
    <div class="modal fade" id="userNavModal" tabindex="-1" aria-labelledby="userNavModalLabel" aria-hidden="true">
        <div class="modal-dialog" id="userNavModalDialog">
            <div class="modal-content">
                <% if !user_signed_in? %>
                    <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdropLabel"> Non hai ancora effettuato l'accesso </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <button onclick="window.location.href='/users/sign_in'" class="dropdown-item"> Accedi </button>
                        <button onclick="window.location.href='/users/sign_up'" class="dropdown-item"> Registrati </button>
                    </div>
                <% else %>
                    <div class="modal-header">
                        <h5 class="modal-title px-2" id="staticBackdropLabel"> Utente: <%= current_user.email %> </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <button onclick="window.location.href='/personal_area'" class="dropdown-item">Area personale</button>
                        <%= button_to 'Esci', destroy_user_session_path, method: :delete, :class => "dropdown-item" %>
                    </div>
                <% end %>
            </div>
        </div>
    </div>
    <!-- Modal delle notifiche flash -->
    <div class="modal fade" id="flashNavModal" tabindex="-1" aria-labelledby="flashNavModalLabel" aria-hidden="true">
        <div class="modal-dialog" id="flashNavModalDialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title px-2" id="staticBackdropLabel"> <%= @flash_messages.size %> messaggi da Spacebook </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <% @flash_messages.each do |msg| %>
                        <%= msg %><br>
                        <hr class="dropdown-divider" />
                    <% end %>
                </div>
            </div>
        </div>
    </div>

    <!-- Controlla se la pagina corrente è tra quelle nella condizione -->
    <% if !current_page?("/users/sign_up") and !current_page?("/users/sign_in") and !current_page?("/make_department")%>
        <div id="layoutSidenav">             <!-- In caso negativo mostra sia la barra laterale del sito, sia lo yeld della pagina corrente, sia il footer -->
            <div id="layoutSidenav_nav">     <!-- Barra laterale -->
                <nav class="sb-sidenav accordion sb-sidenav-dark pt-4" id="sidenavAccordion"> 
                    <div class="sb-sidenav-menu pt-4">
                        <div class="nav">

                            <a class="nav-link" onclick="window.location.href='/home'">
                                <div class="sb-nav-link-icon bi bi-house-fill"></div>
                                HOME
                            </a>

                            <a class="nav-link" onclick="window.location.href='/make_reservation'">
                                <div class="sb-nav-link-icon bi bi-card-list"></div>
                                Effettua prenotazione
                            </a>

                            <!-- Controlla il ruolo dell'utente e ne visualizza le rispettive funzionalità -->
                            <% if user_signed_in? && current_user.roles in ["manager"]%>
                                <a class="nav-link" onclick="window.location.href='/manager_department'">
                                    <div class="sb-nav-link-icon bi bi-building"></div>
                                    Mio dipartimento
                                </a>
                            <% elsif user_signed_in? && current_user.roles in ["admin"]%>
                                <a class="nav-link" onclick="window.location.href='/management'">
                                    <div class="sb-nav-link-icon fas fa-tachometer-alt"></div>
                                    Gestione sito
                                </a>
                            <% end %>

                            <a class="nav-link" onclick="window.location.href='/informations'"> 
                                <div class="sb-nav-link-icon bi-info-circle"></div>
                                Informazioni 
                            </a>

                        </div>
                    </div>
                    <div class="sb-sidenav-footer">
                        <div class="text-muted"> Copyright &copy; Spacebook </div>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content"> <!-- Corpo della pagina corrente -->
                <main>
                    <div class="container-fluid px-4 pt-4">
                        <%= yield %>
                    </div>
                </main>

                <footer class="py-4 bg-light mt-4">
                    <div class="container-fluid px-4">
                        <div class="d-flex align-items-center justify-content-between small">
                            <div class="ms-auto">
                                <a href="#">Privacy Policy</a>
                                &middot;
                                <a href="#">Terms &amp; Conditions</a>
                            </div>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
    <% else %>                               <!-- In caso positivo mostra solo lo yield della pagina corrente -->
        <%= yield %>
    <% end %>

</body>
</html>