<!DOCTYPE html>
<html lang="it">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>

    <% if user_signed_in?%>
        <%= javascript_pack_tag 'optimised_session_timeout_poller'%> <!-- INIZIALIIZZA IL TIMER DI INATTIVITÀ -->
    <% end %>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

</head>

<body class="sb-nav-fixed">

    <%
    # Controlla se l'utente ha effettuato l'accesso, se è manager e se non ha ancora un dipartimento creato
    if user_signed_in? and current_user.is_manager? and !current_page?('/make_department') and (Department.where(manager: current_user.email).count == 0)
        # In caso positivo viene reindirizzato di forza alla pagina '/make_department' tramite la funzione sotto riportata (Si veda 'application_controller.rb' per il corpo della funzione)
        require_department
    end

    # Cattura i messaggi di notifica e li mostra nel modal delle notifiche flash
    flash_messages = []
    flash.each do |type, msg|
        flash_messages.concat([msg])
    end
    %>

    <!-- Header del sito -->
    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
        <table width="100%">
            <tr>
                <!-- Icone alternate per sidenav e home -->
                <td width="6%" style="text-align:left">
                    <% if !current_page?("/users/sign_up") and !current_page?("/users/sign_in") and !current_page?("/make_department") and !current_page?("/make_quick_res") %>
                        <!-- Icona per il toggle della sidenav -->
                        <div class="btn btn-outline-info bi bi-arrow-left-right ms-3" id="sidebarToggle"></div>
                    <% else %>
                        <!-- Icona per il reindirizzamento alla home in assenza della sidenav -->
                        <div class="btn btn-outline-info bi bi-house-fill ms-3" id="homeBtnWhenNoSidenav" onclick="window.location.href='/home'"></div>
                    <% end %>
                </td>
                <!-- Brand -->
                <td width="88%">
                    <a class="navbar-brand text-center"><h1> S P A C E B O O K </h1></a>
                </td>
                <!-- Icona interattiva per visualizzare le notifiche flash da spacebook -->
                <td width="3%" style="text-align:right">
                    <% if flash_messages.size != 0%>
                        <div class="btn btn-outline-info bi bi-chat-text-fill me-3" type="button" data-bs-toggle="modal" id="flashNavModalButton" data-bs-target="#flashNavModal">
                            <!-- Badge con il numero di messaggi -->
                            <span class="position-absolute badge rounded-pill bg-danger mt-1"><%= flash_messages.size %></span>
                        </div>
                    <% else %>
                        <div class="btn btn-outline-info bi bi-chat me-3" type="button" data-bs-toggle="modal" id="flashNavModalButton" data-bs-target="#flashNavModal"></div>
                    <% end %>
                </td>
                <!-- Icona interattiva per visualizzare il modal dell'utente -->
                <td width="3%" style="text-align:right">
                    <% if user_signed_in?%>
                        <div class="btn btn-outline-info bi bi-person-fill me-3" type="button" data-bs-toggle="modal" id="userNavModalButton" data-bs-target="#userNavModal"></div>
                    <% else %>
                        <div class="btn btn-outline-info bi bi-person me-3" type="button" data-bs-toggle="modal" id="userNavModalButton" data-bs-target="#userNavModal"></div>
                    <% end %>
                </td>
            </tr>
        </table>
    </nav>

    <!-- Modal delle notifiche flash -->
    <%= render 'layouts/modal_flash_msg', flash_messages: flash_messages %>
    <!-- Modal dell'utente -->
    <%= render 'layouts/modal_user' %>

    <!-- Controlla se la pagina corrente è tra quelle nella condizione -->
    <% if !current_page?("/users/sign_up") and !current_page?("/users/sign_in") and !current_page?("/make_department") and !current_page?("/make_quick_res")%>
        <div id="layoutSidenav">         <!-- In caso negativo mostra sia la barra laterale del sito, sia lo yeld della pagina corrente, sia il footer -->
            <div id="layoutSidenav_nav"> <!-- Barra laterale -->
                <nav class="sb-sidenav accordion sb-sidenav-dark pt-4" id="sidenavAccordion"> 
                    <div class="sb-sidenav-menu pt-4">
                        <div class="nav">

                            <a class="nav-link" onclick="window.location.href='/home'">
                                <div class="sb-nav-link-icon bi bi-house-fill"></div>
                                HOME
                            </a>

                            <a class="nav-link" onclick="window.location.href='/make_reservation'">
                                <div class="sb-nav-link-icon bi bi-card-list"></div>
                                Effettua prenotazione
                            </a>

                            <!-- Controlla il ruolo dell'utente e ne visualizza le rispettive funzionalità -->
                            <% if user_signed_in? && current_user.roles in ["manager"]%>
                                <a class="nav-link" onclick="window.location.href='/manager_department'">
                                    <div class="sb-nav-link-icon bi bi-building"></div>
                                    Mio dipartimento
                                </a>
                            <% elsif user_signed_in? && current_user.roles in ["admin"]%>
                                <a class="nav-link" onclick="window.location.href='/management'">
                                    <div class="sb-nav-link-icon bi bi-gear-wide-connected"></div>
                                    Gestione sito
                                </a>
                            <% end %>

                            <a class="nav-link" onclick="window.location.href='/informations'"> 
                                <div class="sb-nav-link-icon bi-info-circle"></div>
                                Informazioni 
                            </a>

                        </div>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content"> <!-- Corpo della pagina corrente -->
                <main>
                    <div class="container-fluid px-4 pt-4 pb-5">
                        <%= yield %>
                    </div>
                </main>
            </div>

            <!-- FOOTER -->
            <footer class="container-fluid px-4 py-4 mt-4 bg-info d-flex justify-content-between small" id="bottomFooter">
               
            </footer>
        </div>
    <% else %>                           <!-- In caso positivo mostra solo lo yield della pagina corrente -->
        <%= yield %>
    <% end %>

</body>
</html>